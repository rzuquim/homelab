server {
    listen 443 ssl http2;
    server_name {{ gitea_domain }};

    include ./snippets/nginx.tls-service.conf;

    include ./snippets/nginx.basic-sec.conf;
    include ./snippets/nginx.robots-block-all.conf;

    # NOTE: when updating gitea the CSP hashes will certanly change
    {% set gitea_csp_policy %}
    default-src 'self';
    img-src 'self' data: blob:;
    font-src 'self' data:;
    manifest-src 'self' data:;
    script-src
        'self'
    ;
    script-src-elem 
        'self'
        'unsafe-inline'
    ;
    script-src-attr
        'unsafe-hashes'
        'sha256-Zu12xkRbVekJ0J19JuXt/7ctelDyACr8pjOrSh9HR1o='
    ;
    style-src 'self'
        'sha256-47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU='
        'sha256-faU7yAF8NxuMTNEwVmBz+VcYeIoBQ2EMHW3WaVxCvnk='
    ;
    {% endset %}

    add_header 
        Content-Security-Policy 
        "{{ gitea_csp_policy | replace('\n', ' ') | regex_replace('\s\s+', ' ') | trim }}" 
        always;

    location / {
        proxy_pass http://127.0.0.1:3000;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
}
